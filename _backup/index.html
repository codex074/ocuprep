<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ED-Extemp | ระบบเตรียมยาตาเฉพาะราย</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary:#F0F4F8;--bg-card:#FFF;--bg-sidebar:#0F172A;--bg-sidebar-hover:#1E293B;
  --text-primary:#0F172A;--text-secondary:#475569;--text-muted:#94A3B8;--text-sidebar:#CBD5E1;
  --accent-blue:#2563EB;--accent-blue-light:#DBEAFE;--accent-blue-hover:#1D4ED8;
  --accent-green:#059669;--accent-green-light:#D1FAE5;
  --accent-amber:#D97706;--accent-amber-light:#FEF3C7;
  --accent-red:#DC2626;--accent-red-light:#FEE2E2;
  --accent-purple:#7C3AED;--accent-purple-light:#EDE9FE;
  --accent-teal:#0D9488;--accent-teal-light:#CCFBF1;
  --border:#E2E8F0;--shadow-sm:0 1px 2px rgba(0,0,0,.05);
  --shadow-md:0 4px 6px -1px rgba(0,0,0,.07),0 2px 4px -2px rgba(0,0,0,.05);
  --shadow-lg:0 10px 15px -3px rgba(0,0,0,.08),0 4px 6px -4px rgba(0,0,0,.04);
  --shadow-xl:0 20px 25px -5px rgba(0,0,0,.1),0 8px 10px -6px rgba(0,0,0,.06);
  --radius-sm:6px;--radius-md:10px;--radius-lg:14px;--radius-xl:20px;
  --font-body:'IBM Plex Sans Thai','Sarabun',sans-serif;--font-mono:'JetBrains Mono',monospace;
  --sidebar-w:260px;--header-h:64px;--tr:all .25s cubic-bezier(.4,0,.2,1);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font-body);background:var(--bg-primary);color:var(--text-primary);line-height:1.6;overflow:hidden;height:100vh}

/* LOGIN */
#login-page{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#0F172A 0%,#1E3A5F 50%,#0F172A 100%);position:relative;overflow:hidden}
#login-page::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse at 30% 50%,rgba(37,99,235,.15) 0%,transparent 50%),radial-gradient(ellipse at 70% 50%,rgba(14,165,233,.1) 0%,transparent 50%);animation:bgFloat 20s ease-in-out infinite}
@keyframes bgFloat{0%,100%{transform:translate(0,0)}33%{transform:translate(2%,-1%)}66%{transform:translate(-1%,1%)}}
.login-container{position:relative;z-index:1;width:420px;max-width:90vw;animation:fadeUp .6s ease-out}
@keyframes fadeUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
.login-logo{text-align:center;margin-bottom:32px}
.login-logo .logo-icon{width:72px;height:72px;background:linear-gradient(135deg,#2563EB,#0EA5E9);border-radius:20px;display:inline-flex;align-items:center;justify-content:center;margin-bottom:16px;box-shadow:0 8px 32px rgba(37,99,235,.3)}
.login-logo .logo-icon svg{width:36px;height:36px;color:#fff}
.login-logo h1{color:#fff;font-size:28px;font-weight:700;letter-spacing:-.5px}
.login-logo p{color:#94A3B8;font-size:14px;margin-top:4px}
.login-card{background:rgba(255,255,255,.05);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);border-radius:var(--radius-xl);padding:36px}
.login-card .form-group{margin-bottom:20px}
.login-card label{display:block;color:#CBD5E1;font-size:13px;font-weight:500;margin-bottom:6px}
.login-card input,.login-card select{width:100%;padding:12px 16px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.15);border-radius:var(--radius-md);color:#fff;font-size:15px;font-family:var(--font-body);transition:var(--tr);outline:none}
.login-card input::placeholder{color:#64748B}
.login-card input:focus,.login-card select:focus{border-color:var(--accent-blue);box-shadow:0 0 0 3px rgba(37,99,235,.2);background:rgba(255,255,255,.1)}
.login-card select option{background:#1E293B;color:#fff}
.login-btn{width:100%;padding:14px;background:linear-gradient(135deg,#2563EB,#1D4ED8);color:#fff;border:none;border-radius:var(--radius-md);font-size:16px;font-weight:600;font-family:var(--font-body);cursor:pointer;transition:var(--tr);margin-top:8px}
.login-btn:hover{transform:translateY(-1px);box-shadow:0 8px 25px rgba(37,99,235,.35)}
.login-footer{text-align:center;margin-top:24px;color:#64748B;font-size:12px}

/* LAYOUT */
#app-page{display:none;height:100vh}
.app-layout{display:flex;height:100%}
.sidebar{width:var(--sidebar-w);background:var(--bg-sidebar);display:flex;flex-direction:column;flex-shrink:0;border-right:1px solid rgba(255,255,255,.06)}
.sidebar-header{padding:20px 20px 16px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:12px}
.sidebar-header .s-logo{width:40px;height:40px;background:linear-gradient(135deg,#2563EB,#0EA5E9);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.sidebar-header .s-logo svg{width:20px;height:20px;color:#fff}
.sidebar-header .s-title h2{color:#fff;font-size:16px;font-weight:700;line-height:1.2}
.sidebar-header .s-title p{color:#64748B;font-size:11px}
.sidebar-nav{flex:1;padding:12px 10px;overflow-y:auto}
.nav-label{color:#475569;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;padding:16px 12px 6px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-md);color:var(--text-sidebar);cursor:pointer;transition:var(--tr);font-size:14px;margin-bottom:2px}
.nav-item:hover{background:var(--bg-sidebar-hover);color:#fff}
.nav-item.active{background:var(--accent-blue);color:#fff;font-weight:500;box-shadow:0 2px 8px rgba(37,99,235,.3)}
.nav-item svg{width:18px;height:18px;flex-shrink:0;opacity:.7}
.nav-item.active svg{opacity:1}
.nav-item .badge{margin-left:auto;background:rgba(255,255,255,.15);color:#fff;font-size:11px;padding:1px 8px;border-radius:10px;font-weight:500}
.sidebar-footer{padding:12px 16px;border-top:1px solid rgba(255,255,255,.06)}
.user-info{display:flex;align-items:center;gap:10px;padding:8px;border-radius:var(--radius-md);cursor:pointer;transition:var(--tr)}
.user-info:hover{background:var(--bg-sidebar-hover)}
.user-avatar{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#059669,#10B981);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:14px;flex-shrink:0}
.user-details{flex:1;min-width:0}
.user-details .name{color:#fff;font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-details .role{color:#64748B;font-size:11px}
.logout-btn{background:none;border:none;color:#64748B;cursor:pointer;padding:4px;border-radius:6px;transition:var(--tr);display:flex}
.logout-btn:hover{color:#EF4444;background:rgba(239,68,68,.1)}
.logout-btn svg{width:16px;height:16px}

.main-content{flex:1;display:flex;flex-direction:column;overflow:hidden}
.main-header{height:var(--header-h);background:var(--bg-card);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 28px;gap:16px;flex-shrink:0}
.page-title{font-size:20px;font-weight:700;flex:1}
.main-body{flex:1;overflow-y:auto;padding:28px;scroll-behavior:smooth}

/* COMPONENTS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:10px 18px;border:none;border-radius:var(--radius-md);font-family:var(--font-body);font-size:14px;font-weight:500;cursor:pointer;transition:var(--tr);white-space:nowrap}
.btn svg{width:16px;height:16px}
.btn-primary{background:var(--accent-blue);color:#fff}
.btn-primary:hover{background:var(--accent-blue-hover);transform:translateY(-1px);box-shadow:var(--shadow-md)}
.btn-success{background:var(--accent-green);color:#fff}
.btn-success:hover{background:#047857}
.btn-danger{background:var(--accent-red);color:#fff}
.btn-outline{background:transparent;color:var(--text-secondary);border:1px solid var(--border)}
.btn-outline:hover{background:#F8FAFC;border-color:#CBD5E1}
.btn-ghost{background:transparent;color:var(--text-secondary)}
.btn-ghost:hover{background:#F1F5F9}
.btn-sm{padding:6px 12px;font-size:13px}
.btn-sm svg{width:14px;height:14px}

.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);transition:var(--tr)}
.card:hover{box-shadow:var(--shadow-md)}
.card-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px}
.card-header h3{font-size:16px;font-weight:600}
.card-body{padding:24px}

.form-group{margin-bottom:18px}
.form-group label{display:block;font-size:13px;font-weight:500;color:var(--text-secondary);margin-bottom:6px}
.form-group label .req{color:var(--accent-red);margin-left:2px}
.form-input,.form-select,.form-textarea{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:var(--radius-md);font-size:14px;font-family:var(--font-body);color:var(--text-primary);background:#fff;transition:var(--tr);outline:none}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--accent-blue);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.form-input::placeholder{color:var(--text-muted)}
.form-textarea{resize:vertical;min-height:80px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}

.toggle-group{display:flex;border:1px solid var(--border);border-radius:var(--radius-md);overflow:hidden}
.toggle-option{flex:1;padding:10px 16px;text-align:center;cursor:pointer;font-size:13px;font-weight:500;transition:var(--tr);color:var(--text-secondary);background:#fff;border-right:1px solid var(--border)}
.toggle-option:last-child{border-right:none}
.toggle-option.active{background:var(--accent-blue);color:#fff}
.toggle-option:hover:not(.active){background:#F8FAFC}

.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;display:flex;align-items:flex-start;gap:14px;transition:var(--tr)}
.stat-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
.stat-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.stat-icon svg{width:22px;height:22px}
.stat-icon.blue{background:var(--accent-blue-light);color:var(--accent-blue)}
.stat-icon.green{background:var(--accent-green-light);color:var(--accent-green)}
.stat-icon.amber{background:var(--accent-amber-light);color:var(--accent-amber)}
.stat-icon.purple{background:var(--accent-purple-light);color:var(--accent-purple)}
.stat-info h4{font-size:24px;font-weight:700;line-height:1.1}
.stat-info p{font-size:13px;color:var(--text-muted);margin-top:2px}

.table-wrapper{overflow-x:auto}
table{width:100%;border-collapse:collapse}
table th{text-align:left;padding:12px 16px;font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;background:#F8FAFC;border-bottom:1px solid var(--border);white-space:nowrap}
table td{padding:12px 16px;font-size:14px;border-bottom:1px solid #F1F5F9;vertical-align:middle}
table tbody tr{transition:var(--tr)}
table tbody tr:hover{background:#F8FAFC}

.badge-tag{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:500}
.badge-tag.blue{background:var(--accent-blue-light);color:var(--accent-blue)}
.badge-tag.green{background:var(--accent-green-light);color:var(--accent-green)}
.badge-tag.amber{background:var(--accent-amber-light);color:var(--accent-amber)}
.badge-tag.red{background:var(--accent-red-light);color:var(--accent-red)}
.badge-tag.purple{background:var(--accent-purple-light);color:var(--accent-purple)}
.badge-tag.teal{background:var(--accent-teal-light);color:var(--accent-teal)}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(15,23,42,.5);backdrop-filter:blur(4px);z-index:1000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s ease}
.modal-overlay.show{opacity:1;pointer-events:all}
.modal{background:#fff;border-radius:var(--radius-xl);width:540px;max-width:90vw;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow-xl);transform:scale(.95) translateY(10px);transition:transform .25s ease}
.modal-overlay.show .modal{transform:scale(1) translateY(0)}
.modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-header h3{font-size:18px;font-weight:600}
.modal-close{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:4px;border-radius:6px;transition:var(--tr);display:flex}
.modal-close:hover{background:#F1F5F9;color:var(--text-primary)}
.modal-close svg{width:20px;height:20px}
.modal-body{padding:24px}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}

/* TOAST */
.toast-container{position:fixed;top:20px;right:20px;z-index:2000;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--bg-sidebar);color:#fff;padding:14px 20px;border-radius:var(--radius-md);font-size:14px;box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:10px;animation:toastIn .3s ease-out,toastOut .3s ease-in 2.7s forwards;min-width:280px}
.toast.success{border-left:4px solid var(--accent-green)}
.toast.error{border-left:4px solid var(--accent-red)}
.toast.info{border-left:4px solid var(--accent-blue)}
.toast svg{width:18px;height:18px;flex-shrink:0}
@keyframes toastIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
@keyframes toastOut{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(40px)}}

.page-section{display:none}
.page-section.active{display:block;animation:pageFade .3s ease}
@keyframes pageFade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

.recent-grid{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-top:20px}
.formula-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
.formula-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;cursor:pointer;transition:var(--tr);position:relative;overflow:hidden}
.formula-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent-blue),var(--accent-teal));opacity:0;transition:var(--tr)}
.formula-card:hover{transform:translateY(-3px);box-shadow:var(--shadow-lg);border-color:var(--accent-blue)}
.formula-card:hover::before{opacity:1}
.formula-card h4{font-size:15px;font-weight:600;margin-bottom:6px}
.formula-card .fdesc{font-size:13px;color:var(--text-muted);margin-bottom:12px;line-height:1.5}
.formula-card .fmeta{display:flex;gap:8px;flex-wrap:wrap}

.filter-bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
.search-box{position:relative;flex:1;min-width:200px}
.search-box input{width:100%;padding:10px 14px 10px 38px;border:1px solid var(--border);border-radius:var(--radius-md);font-size:14px;font-family:var(--font-body);outline:none;transition:var(--tr)}
.search-box input:focus{border-color:var(--accent-blue);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.search-box svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);width:16px;height:16px;color:var(--text-muted)}

.label-preview{max-width:400px;margin:0 auto;border:2px solid #333;border-radius:8px;padding:16px;font-size:13px}
.label-preview .lh{text-align:center;border-bottom:1px solid #333;padding-bottom:8px;margin-bottom:10px}
.label-preview .lh h4{font-size:14px}
.label-preview .lh p{font-size:11px;color:#666}
.label-preview .lb{line-height:1.8}
.label-preview .lb .row{display:flex;justify-content:space-between}
.label-preview .lf{border-top:1px solid #333;margin-top:10px;padding-top:8px;font-size:11px;text-align:center;color:#666}

.user-avatar-sm{width:32px;height:32px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:13px}

@media(max-width:768px){
  .sidebar{display:none}.form-row,.form-row-3{grid-template-columns:1fr}
  .recent-grid{grid-template-columns:1fr}.stats-grid{grid-template-columns:1fr 1fr}
  .main-body{padding:16px}
}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:#94A3B8}
</style>
</head>
<body>
<div class="toast-container" id="toastContainer"></div>

<!-- LOGIN -->
<div id="login-page">
  <div class="login-container">
    <div class="login-logo">
      <div class="logo-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg>
      </div>
      <h1>ED-Extemp</h1>
      <p>ระบบเตรียมยาตาเฉพาะราย — โรงพยาบาลอุตรดิตถ์</p>
    </div>
    <div class="login-card">
      <div class="form-group">
        <label>รหัสเภสัชกร / Username</label>
        <input type="text" id="loginUser" placeholder="เช่น PHA001" autocomplete="off">
      </div>
      <div class="form-group">
        <label>รหัสผ่าน</label>
        <input type="password" id="loginPass" placeholder="กรอกรหัสผ่าน">
      </div>
      <div class="form-group">
        <label>สถานที่ปฏิบัติงาน</label>
        <select id="loginLoc">
          <option value="OPD">ห้องจ่ายยาผู้ป่วยนอก (OPD)</option>
          <option value="IPD">ห้องยาผู้ป่วยใน (IPD)</option>
          <option value="ER">ห้องฉุกเฉิน (ER)</option>
          <option value="OR">ห้องผ่าตัด (OR)</option>
          <option value="PROD">ห้องผลิตยา (Production)</option>
        </select>
      </div>
      <button class="login-btn" onclick="doLogin()">เข้าสู่ระบบ</button>
      <div style="margin-top:12px;text-align:center;font-size:12px;color:#64748B;">Demo: PHA001 / 1234</div>
    </div>
    <div class="login-footer">© 2026 Uttaradit Hospital — Pharmacy Department</div>
  </div>
</div>

<!-- APP -->
<div id="app-page">
  <div class="app-layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="s-logo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><circle cx="12" cy="12" r="3"/></svg></div>
        <div class="s-title"><h2>ED-Extemp</h2><p>Pharmacy System</p></div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-label">หน้าหลัก</div>
        <div class="nav-item active" onclick="nav('dashboard')" data-page="dashboard">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
          แดชบอร์ด
        </div>
        <div class="nav-item" onclick="nav('prepare')" data-page="prepare">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
          เตรียมยา
        </div>
        <div class="nav-item" onclick="nav('history')" data-page="history">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          ประวัติการผลิต <span class="badge" id="hBadge">0</span>
        </div>
        <div class="nav-label">จัดการระบบ</div>
        <div class="nav-item" onclick="nav('formulas')" data-page="formulas">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
          สูตรตำรับยา
        </div>
        <div class="nav-item" onclick="nav('users')" data-page="users" id="navUsers">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          จัดการผู้ใช้
        </div>
      </nav>
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="sAvatar">ภ</div>
          <div class="user-details"><div class="name" id="sName">เภสัชกร</div><div class="role" id="sRole">User</div></div>
          <button class="logout-btn" onclick="doLogout()" title="ออกจากระบบ">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          </button>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <header class="main-header">
        <h1 class="page-title" id="pageTitle">แดชบอร์ด</h1>
        <div style="display:flex;gap:12px;align-items:center;">
          <span style="font-size:13px;color:var(--text-muted)" id="hLoc">OPD</span>
          <span style="font-size:13px;color:var(--text-muted)" id="hDate"></span>
        </div>
      </header>
      <div class="main-body">

        <!-- DASHBOARD -->
        <div class="page-section active" id="page-dashboard">
          <div class="stats-grid" id="statsGrid"></div>
          <div class="recent-grid">
            <div class="card">
              <div class="card-header"><h3>รายการล่าสุด</h3><button class="btn btn-sm btn-outline" onclick="nav('history')">ดูทั้งหมด →</button></div>
              <div class="card-body" style="padding:0"><div class="table-wrapper"><table><thead><tr><th>วันที่</th><th>สูตรยา</th><th>ประเภท</th><th>ผู้เตรียม</th></tr></thead><tbody id="dashRecent"><tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:32px">ยังไม่มีรายการ</td></tr></tbody></table></div></div>
            </div>
            <div class="card">
              <div class="card-header"><h3>สรุปสูตรยา</h3></div>
              <div class="card-body" id="dashSummary"><p style="text-align:center;color:var(--text-muted);padding:20px">ข้อมูลจะแสดงหลังเริ่มเตรียมยา</p></div>
            </div>
          </div>
        </div>

        <!-- PREPARE -->
        <div class="page-section" id="page-prepare">
          <div class="card">
            <div class="card-header"><h3>เตรียมยาตาเฉพาะราย</h3></div>
            <div class="card-body">
              <div class="form-group"><label>เลือกสูตรตำรับยา <span class="req">*</span></label><select class="form-select" id="pFormula" onchange="onFormulaSelect()"><option value="">-- เลือกสูตรตำรับ --</option></select></div>
              <div class="form-group"><label>รูปแบบการเตรียม <span class="req">*</span></label>
                <div class="toggle-group"><div class="toggle-option active" onclick="setMode('patient')">เฉพาะราย (Patient)</div><div class="toggle-option" onclick="setMode('stock')">Stock</div></div>
              </div>
              <div id="patientFields">
                <div class="form-row">
                  <div class="form-group"><label>HN ผู้ป่วย <span class="req">*</span></label><input class="form-input" id="pHN" placeholder="เช่น 12345678"></div>
                  <div class="form-group"><label>ชื่อ-นามสกุล <span class="req">*</span></label><input class="form-input" id="pName" placeholder="เช่น สมชาย ใจดี"></div>
                </div>
              </div>
              <div id="stockFields" style="display:none">
                <div class="form-group"><label>ห้องปลายทาง <span class="req">*</span></label>
                  <select class="form-select" id="pRoom"><option value="">-- เลือกห้อง --</option><option value="OPD">OPD</option><option value="IPD">IPD</option><option value="ER">ER</option><option value="OR">OR</option><option value="EYE_OPD">Eye Clinic</option></select>
                </div>
              </div>
              <div class="form-row-3">
                <div class="form-group"><label>Lot No. <span class="req">*</span></label><input class="form-input" id="pLot"></div>
                <div class="form-group"><label>วันที่เตรียม</label><input class="form-input" type="date" id="pDate"></div>
                <div class="form-group"><label>จำนวน (ขวด)</label><input class="form-input" type="number" id="pQty" value="1" min="1"></div>
              </div>
              <div class="form-group"><label>หมายเหตุ</label><textarea class="form-textarea" id="pNote" rows="2" placeholder="หมายเหตุเพิ่มเติม (ถ้ามี)"></textarea></div>
              <div id="formulaPreview" style="display:none;margin-top:16px">
                <div style="background:#F0F9FF;border:1px solid #BAE6FD;border-radius:var(--radius-md);padding:16px">
                  <h4 style="font-size:14px;color:var(--accent-blue);margin-bottom:10px">รายละเอียดสูตรตำรับ</h4>
                  <div id="fpContent"></div>
                </div>
              </div>
              <div style="display:flex;gap:10px;margin-top:24px;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="savePrepare()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> บันทึก</button>
                <button class="btn btn-success" onclick="printLabel()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg> พิมพ์ฉลากยา</button>
                <button class="btn btn-outline" onclick="printBatch()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> พิมพ์ใบสูตรผลิต</button>
              </div>
            </div>
          </div>
        </div>

        <!-- HISTORY -->
        <div class="page-section" id="page-history">
          <div class="card">
            <div class="card-header"><h3>ประวัติการผลิต</h3>
              <div style="display:flex;gap:8px"><button class="btn btn-sm btn-outline" onclick="exportCSV()">Export CSV</button><button class="btn btn-sm btn-outline" onclick="exportJSON()">Export JSON</button></div>
            </div>
            <div class="card-body" style="padding-bottom:0">
              <div class="filter-bar">
                <div class="search-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="ค้นหาชื่อยา, ผู้ป่วย, เภสัชกร..." id="hSearch" oninput="filterHist()"></div>
                <select class="form-select" style="width:auto;min-width:130px" id="hRoomF" onchange="filterHist()"><option value="">ทุกห้อง</option><option value="OPD">OPD</option><option value="IPD">IPD</option><option value="ER">ER</option><option value="OR">OR</option><option value="PROD">Production</option></select>
                <input type="date" class="form-input" style="width:auto" id="hFrom" onchange="filterHist()">
                <span style="color:var(--text-muted);font-size:13px">ถึง</span>
                <input type="date" class="form-input" style="width:auto" id="hTo" onchange="filterHist()">
              </div>
            </div>
            <div class="table-wrapper" style="padding:0 24px 24px">
              <table><thead><tr><th>#</th><th>วันที่</th><th>สูตรยา</th><th>ประเภท</th><th>ผู้ป่วย/ห้อง</th><th>Lot</th><th>ผู้เตรียม</th><th>สถานที่</th><th></th></tr></thead>
              <tbody id="histBody"><tr><td colspan="9" style="text-align:center;color:var(--text-muted);padding:40px">ยังไม่มีรายการ</td></tr></tbody></table>
            </div>
          </div>
        </div>

        <!-- FORMULAS -->
        <div class="page-section" id="page-formulas">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <div><h3 style="font-size:16px;font-weight:600">สูตรตำรับยาทั้งหมด</h3><p style="font-size:13px;color:var(--text-muted)">เพิ่ม แก้ไข หรือลบสูตรตำรับ</p></div>
            <button class="btn btn-primary" onclick="openFM()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> เพิ่มสูตรตำรับ</button>
          </div>
          <div class="formula-grid" id="fGrid"></div>
        </div>

        <!-- USERS -->
        <div class="page-section" id="page-users">
          <div class="card">
            <div class="card-header"><h3>จัดการผู้ใช้งาน</h3><button class="btn btn-sm btn-primary" onclick="openUM()">เพิ่มผู้ใช้</button></div>
            <div class="table-wrapper"><table><thead><tr><th>เภสัชกร</th><th>รหัส</th><th>สิทธิ์</th><th>สถานะ</th><th></th></tr></thead><tbody id="userBody"></tbody></table></div>
          </div>
        </div>

      </div>
    </main>
  </div>
</div>

<!-- FORMULA MODAL -->
<div class="modal-overlay" id="fmModal">
  <div class="modal" style="width:600px">
    <div class="modal-header"><h3 id="fmTitle">เพิ่มสูตรตำรับยา</h3><button class="modal-close" onclick="closeM('fmModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body">
      <div class="form-group"><label>ชื่อสูตรตำรับ <span class="req">*</span></label><input class="form-input" id="fName"></div>
      <div class="form-group"><label>คำอธิบาย</label><input class="form-input" id="fDesc"></div>
      <div class="form-row">
        <div class="form-group"><label>ความเข้มข้น</label><input class="form-input" id="fConc"></div>
        <div class="form-group"><label>อายุยา (วัน)</label><input class="form-input" type="number" id="fExp" value="7"></div>
      </div>
      <div class="form-group"><label>ส่วนประกอบ</label><textarea class="form-textarea" id="fIng" rows="3"></textarea></div>
      <div class="form-group"><label>วิธีเตรียม</label><textarea class="form-textarea" id="fMeth" rows="3"></textarea></div>
      <div class="form-row">
        <div class="form-group"><label>ราคา (บาท)</label><input class="form-input" type="number" id="fPrice" value="0"></div>
        <div class="form-group"><label>หมวดหมู่</label><select class="form-select" id="fCat"><option value="antibiotic">Antibiotic</option><option value="antifungal">Antifungal</option><option value="steroid">Steroid</option><option value="lubricant">Lubricant</option><option value="other">Other</option></select></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeM('fmModal')">ยกเลิก</button><button class="btn btn-primary" onclick="saveFormula()">บันทึก</button></div>
  </div>
</div>

<!-- USER MODAL -->
<div class="modal-overlay" id="umModal">
  <div class="modal">
    <div class="modal-header"><h3>เพิ่มผู้ใช้งาน</h3><button class="modal-close" onclick="closeM('umModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label>ชื่อ-นามสกุล <span class="req">*</span></label><input class="form-input" id="uName"></div>
        <div class="form-group"><label>รหัสเภสัชกร <span class="req">*</span></label><input class="form-input" id="uPhaID"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>รหัสผ่าน <span class="req">*</span></label><input class="form-input" type="password" id="uPass"></div>
        <div class="form-group"><label>สิทธิ์</label><select class="form-select" id="uRole"><option value="user">User</option><option value="admin">Admin</option></select></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeM('umModal')">ยกเลิก</button><button class="btn btn-primary" onclick="saveUser()">บันทึก</button></div>
  </div>
</div>

<!-- PRINT MODAL -->
<div class="modal-overlay" id="printModal">
  <div class="modal" style="width:520px">
    <div class="modal-header"><h3 id="printTitle">ตัวอย่าง</h3><button class="modal-close" onclick="closeM('printModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body" id="printBody"></div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeM('printModal')">ปิด</button><button class="btn btn-primary" onclick="doPrint()">พิมพ์</button></div>
  </div>
</div>

<script>
// ═══ DATA STORE ═══
const DB = {
  users: [
    {id:1,name:'ภก.สมชาย เภสัชกร',phaId:'PHA001',password:'1234',role:'admin',active:true},
    {id:2,name:'ภญ.สมหญิง ยาดี',phaId:'PHA002',password:'1234',role:'user',active:true},
    {id:3,name:'ภก.วิชัย ตาสว่าง',phaId:'PHA003',password:'1234',role:'user',active:true},
  ],
  formulas: [
    {id:1,name:'Fortified Cefazolin Eye Drops',desc:'ยาหยอดตาปฏิชีวนะ Cefazolin ความเข้มข้นสูง',concentration:'50 mg/mL',expiryDays:7,category:'antibiotic',price:150,
     ingredients:'- Cefazolin 1g vial x 1\n- Artificial Tears 15 mL x 1',method:'1. เตรียมในตู้ปลอดเชื้อ\n2. ละลาย Cefazolin ด้วย Artificial Tears\n3. ดูดยาใส่ขวดหยอดตา\n4. ติดฉลาก เก็บในตู้เย็น 2-8°C'},
    {id:2,name:'Fortified Gentamicin Eye Drops',desc:'ยาหยอดตาปฏิชีวนะ Gentamicin ความเข้มข้นสูง',concentration:'14 mg/mL',expiryDays:7,category:'antibiotic',price:120,
     ingredients:'- Gentamicin Inj 80mg/2mL x 1\n- Artificial Tears 15 mL x 1',method:'1. เตรียมในตู้ปลอดเชื้อ\n2. ดูด Gentamicin injection\n3. ผสมกับ Artificial Tears\n4. ติดฉลาก เก็บตู้เย็น 2-8°C'},
    {id:3,name:'Fortified Vancomycin Eye Drops',desc:'ยาหยอดตาปฏิชีวนะ Vancomycin',concentration:'25 mg/mL',expiryDays:7,category:'antibiotic',price:350,
     ingredients:'- Vancomycin 500mg vial x 1\n- SWFI 10 mL\n- Artificial Tears 15 mL',method:'1. ละลาย Vancomycin ด้วย SWFI 10 mL\n2. ดูด 5 mL ผสม Artificial Tears 15 mL\n3. บรรจุขวดหยอดตา\n4. เก็บตู้เย็น 2-8°C'},
    {id:4,name:'Amphotericin B Eye Drops',desc:'ยาหยอดตาต้านเชื้อรา',concentration:'1.5 mg/mL',expiryDays:7,category:'antifungal',price:280,
     ingredients:'- Amphotericin B 50mg vial x 1\n- SWFI 10 mL\n- D5W 15 mL',method:'1. ละลาย Amphotericin B ด้วย SWFI\n2. เจือจางด้วย D5W\n3. กรอง 0.22 µm filter\n4. บรรจุขวด ห่อฟอยล์กันแสง'},
    {id:5,name:'Autologous Serum Eye Drops',desc:'ยาหยอดตาจาก Serum ผู้ป่วย',concentration:'20%',expiryDays:30,category:'lubricant',price:0,
     ingredients:'- เลือดผู้ป่วย (clotted blood)\n- NSS (Normal Saline)',method:'1. เจาะเลือด 20 mL\n2. ปั่นเหวี่ยง 3000 rpm 10 นาที\n3. ดูด Serum เจือจาง NSS 1:4\n4. บรรจุขวด เก็บ -20°C'},
    {id:6,name:'Voriconazole Eye Drops',desc:'ยาหยอดตาต้านเชื้อรา Voriconazole',concentration:'10 mg/mL (1%)',expiryDays:14,category:'antifungal',price:500,
     ingredients:'- Voriconazole 200mg vial x 1\n- SWFI 19 mL',method:'1. ละลาย Voriconazole 200mg ด้วย SWFI 19 mL\n2. ได้ ~10 mg/mL\n3. บรรจุขวดหยอดตา\n4. เก็บตู้เย็น 2-8°C'},
  ],
  preps: [],
  nPrepId:1, nFormulaId:7, nUserId:4
};

let curUser=null, curLoc='', prepMode='patient', editFID=null;

// ═══ UTILS ═══
const today = ()=> new Date().toISOString().split('T')[0];
const fmtDate = d=>{ if(!d)return'-'; return new Date(d).toLocaleDateString('th-TH',{year:'numeric',month:'short',day:'numeric'}); };
const fmtShort = d=>{ if(!d)return'-'; return new Date(d).toLocaleDateString('th-TH',{day:'2-digit',month:'2-digit',year:'2-digit'}); };
const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x.toISOString().split('T')[0]; };
const genLot = ()=> `LOT-${new Date().getFullYear()}${String(new Date().getMonth()+1).padStart(2,'0')}-${String(DB.nPrepId).padStart(3,'0')}`;

function toast(msg, type='info') {
  const c=document.getElementById('toastContainer');
  const icons={success:'<svg viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
    error:'<svg viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
    info:'<svg viewBox="0 0 24 24" fill="none" stroke="#3B82F6" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'};
  const t=document.createElement('div');
  t.className=`toast ${type}`;
  t.innerHTML=`${icons[type]||icons.info}<span>${msg}</span>`;
  c.appendChild(t);
  setTimeout(()=>t.remove(),3200);
}

function openM(id){document.getElementById(id).classList.add('show')}
function closeM(id){document.getElementById(id).classList.remove('show')}

// ═══ AUTH ═══
function doLogin() {
  const u=document.getElementById('loginUser').value.trim(), p=document.getElementById('loginPass').value, l=document.getElementById('loginLoc').value;
  if(!u){toast('กรุณากรอกรหัสเภสัชกร','error');return}
  if(!p){toast('กรุณากรอกรหัสผ่าน','error');return}
  const user=DB.users.find(x=>(x.phaId===u||x.name===u)&&x.password===p&&x.active);
  if(!user){toast('รหัสผู้ใช้หรือรหัสผ่านไม่ถูกต้อง','error');return}
  curUser=user; curLoc=l;
  document.getElementById('login-page').style.display='none';
  document.getElementById('app-page').style.display='block';
  document.getElementById('sAvatar').textContent=user.name.charAt(0);
  document.getElementById('sName').textContent=user.name;
  document.getElementById('sRole').textContent=user.role==='admin'?'Admin':'Pharmacist';
  document.getElementById('hLoc').textContent=l;
  document.getElementById('navUsers').style.display=user.role==='admin'?'flex':'none';
  document.getElementById('hDate').textContent=new Date().toLocaleDateString('th-TH',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  addSampleData();
  nav('dashboard');
  toast(`ยินดีต้อนรับ ${user.name}`,'success');
}

function doLogout() {
  curUser=null;
  document.getElementById('app-page').style.display='none';
  document.getElementById('login-page').style.display='flex';
  document.getElementById('loginPass').value='';
  toast('ออกจากระบบสำเร็จ','info');
}

// ═══ NAVIGATION ═══
const titles={dashboard:'แดชบอร์ด',prepare:'เตรียมยาตาเฉพาะราย',history:'ประวัติการผลิต',formulas:'สูตรตำรับยา',users:'จัดการผู้ใช้งาน'};
function nav(page) {
  document.querySelectorAll('.nav-item').forEach(el=>el.classList.toggle('active',el.dataset.page===page));
  document.querySelectorAll('.page-section').forEach(el=>el.classList.toggle('active',el.id===`page-${page}`));
  document.getElementById('pageTitle').textContent=titles[page]||page;
  if(page==='dashboard')refreshDash();
  if(page==='prepare')refreshPrep();
  if(page==='history')filterHist();
  if(page==='formulas')refreshFormulas();
  if(page==='users')refreshUsers();
}

// ═══ DASHBOARD ═══
function refreshDash() {
  const t=today(), tp=DB.preps.filter(p=>p.date===t), pp=DB.preps.filter(p=>p.mode==='patient');
  const ic=(cls,path)=>`<div class="stat-icon ${cls}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${path}</svg></div>`;
  document.getElementById('statsGrid').innerHTML=[
    {v:DB.preps.length,l:'รายการทั้งหมด',c:'blue',p:'<path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>'},
    {v:tp.length,l:'ผลิตวันนี้',c:'green',p:'<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>'},
    {v:pp.length,l:'เฉพาะราย (Patient)',c:'amber',p:'<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>'},
    {v:DB.formulas.length,l:'สูตรตำรับ',c:'purple',p:'<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>'}
  ].map(s=>`<div class="stat-card">${ic(s.c,s.p)}<div class="stat-info"><h4>${s.v}</h4><p>${s.l}</p></div></div>`).join('');
  document.getElementById('hBadge').textContent=DB.preps.length;

  const recent=[...DB.preps].reverse().slice(0,5);
  document.getElementById('dashRecent').innerHTML=recent.length?recent.map(p=>`<tr><td>${fmtShort(p.date)}</td><td style="font-weight:500">${p.formulaName}</td><td><span class="badge-tag ${p.mode==='patient'?'blue':'teal'}">${p.mode==='patient'?'เฉพาะราย':'Stock'}</span></td><td>${p.preparedBy}</td></tr>`).join(''):'<tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:32px">ยังไม่มีรายการ</td></tr>';

  const sm=document.getElementById('dashSummary');
  if(!DB.preps.length){sm.innerHTML='<p style="text-align:center;color:var(--text-muted);padding:20px">ข้อมูลจะแสดงหลังเริ่มเตรียมยา</p>';return}
  const cnt={};DB.preps.forEach(p=>{cnt[p.formulaName]=(cnt[p.formulaName]||0)+p.qty});
  const sorted=Object.entries(cnt).sort((a,b)=>b[1]-a[1]);
  const cols=['blue','green','amber','purple','teal','red'];
  sm.innerHTML=sorted.map(([n,c],i)=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;${i<sorted.length-1?'border-bottom:1px solid #F1F5F9':''}"><span style="font-size:13px;font-weight:500">${n}</span><span class="badge-tag ${cols[i%6]}">${c} ขวด</span></div>`).join('');
}

// ═══ PREPARE ═══
function refreshPrep() {
  const s=document.getElementById('pFormula');
  s.innerHTML='<option value="">-- เลือกสูตรตำรับ --</option>'+DB.formulas.map(f=>`<option value="${f.id}">${f.name} (${f.concentration})</option>`).join('');
  document.getElementById('pDate').value=today();
  document.getElementById('pLot').value=genLot();
}

function setMode(m) {
  prepMode=m;
  document.querySelectorAll('.toggle-option').forEach((el,i)=>el.classList.toggle('active',(i===0&&m==='patient')||(i===1&&m==='stock')));
  document.getElementById('patientFields').style.display=m==='patient'?'block':'none';
  document.getElementById('stockFields').style.display=m==='stock'?'block':'none';
}

function onFormulaSelect() {
  const f=DB.formulas.find(x=>x.id===+document.getElementById('pFormula').value);
  const pv=document.getElementById('formulaPreview'),ct=document.getElementById('fpContent');
  if(!f){pv.style.display='none';return}
  pv.style.display='block';
  ct.innerHTML=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px"><div><strong>ชื่อ:</strong> ${f.name}</div><div><strong>ความเข้มข้น:</strong> ${f.concentration}</div><div><strong>อายุยา:</strong> ${f.expiryDays} วัน</div><div><strong>ราคา:</strong> ${f.price>0?f.price+' บาท':'ไม่คิดค่าใช้จ่าย'}</div></div><div style="margin-top:10px;font-size:13px"><strong>ส่วนประกอบ:</strong><pre style="margin-top:4px;font-family:var(--font-body);white-space:pre-wrap;color:var(--text-secondary);font-size:12px">${f.ingredients}</pre></div><div style="margin-top:8px;font-size:13px"><strong>วิธีเตรียม:</strong><pre style="margin-top:4px;font-family:var(--font-body);white-space:pre-wrap;color:var(--text-secondary);font-size:12px">${f.method}</pre></div>`;
}

function savePrepare() {
  const f=DB.formulas.find(x=>x.id===+document.getElementById('pFormula').value);
  if(!f){toast('กรุณาเลือกสูตรตำรับยา','error');return}
  const lot=document.getElementById('pLot').value.trim(),date=document.getElementById('pDate').value,qty=+document.getElementById('pQty').value||1,note=document.getElementById('pNote').value.trim();
  if(!lot){toast('กรุณากรอก Lot No.','error');return}
  let target='';
  if(prepMode==='patient'){
    const hn=document.getElementById('pHN').value.trim(),nm=document.getElementById('pName').value.trim();
    if(!hn||!nm){toast('กรุณากรอก HN และชื่อผู้ป่วย','error');return}
    target=`HN: ${hn} - ${nm}`;
  } else {
    const rm=document.getElementById('pRoom').value;
    if(!rm){toast('กรุณาเลือกห้องปลายทาง','error');return}
    target=`Stock → ${rm}`;
  }
  DB.preps.push({id:DB.nPrepId++,formulaId:f.id,formulaName:f.name,concentration:f.concentration,mode:prepMode,target,
    hn:prepMode==='patient'?document.getElementById('pHN').value.trim():'',
    patientName:prepMode==='patient'?document.getElementById('pName').value.trim():'',
    destRoom:prepMode==='stock'?document.getElementById('pRoom').value:'',
    lotNo:lot,date,expiryDate:addDays(date,f.expiryDays),qty,note,preparedBy:curUser.name,location:curLoc,createdAt:new Date().toISOString()});
  toast(`บันทึกสำเร็จ: ${f.name} (${qty} ขวด)`,'success');
  document.getElementById('pHN').value='';document.getElementById('pName').value='';document.getElementById('pNote').value='';
  document.getElementById('pLot').value=genLot();document.getElementById('pQty').value='1';
}

// ═══ PRINT ═══
function printLabel() {
  const f=DB.formulas.find(x=>x.id===+document.getElementById('pFormula').value);
  if(!f){toast('กรุณาเลือกสูตรตำรับยาก่อน','error');return}
  const d=document.getElementById('pDate').value||today(),lot=document.getElementById('pLot').value||'-',exp=addDays(d,f.expiryDays),
    pn=prepMode==='patient'?(document.getElementById('pName').value||'-'):'Stock',hn=prepMode==='patient'?(document.getElementById('pHN').value||'-'):'-';
  document.getElementById('printTitle').textContent='ฉลากยา (Patient Label)';
  document.getElementById('printBody').innerHTML=`<div class="label-preview"><div class="lh"><h4>โรงพยาบาลอุตรดิตถ์</h4><p>กลุ่มงานเภสัชกรรม — ฉลากยาเตรียมเฉพาะราย</p></div><div class="lb"><div class="row"><span>ชื่อยา:</span><strong>${f.name}</strong></div><div class="row"><span>ความเข้มข้น:</span><strong>${f.concentration}</strong></div><div class="row"><span>ผู้ป่วย:</span><strong>${pn}${hn!=='-'?' (HN: '+hn+')':''}</strong></div><div class="row"><span>Lot No.:</span><span>${lot}</span></div><div class="row"><span>วันที่เตรียม:</span><span>${fmtDate(d)}</span></div><div class="row" style="color:var(--accent-red);font-weight:600"><span>วันหมดอายุ:</span><span>${fmtDate(exp)}</span></div><div class="row"><span>วิธีใช้:</span><span>หยอดตาตามแพทย์สั่ง</span></div><div class="row"><span>การเก็บรักษา:</span><span>เก็บในตู้เย็น 2-8°C</span></div></div><div class="lf">ผู้เตรียม: ${curUser?curUser.name:'-'} | ${curLoc}</div></div>`;
  openM('printModal');
}

function printBatch() {
  const f=DB.formulas.find(x=>x.id===+document.getElementById('pFormula').value);
  if(!f){toast('กรุณาเลือกสูตรตำรับยาก่อน','error');return}
  const d=document.getElementById('pDate').value||today(),lot=document.getElementById('pLot').value||'-',qty=document.getElementById('pQty').value||'1';
  document.getElementById('printTitle').textContent='ใบสูตรผลิต (Batch Sheet)';
  document.getElementById('printBody').innerHTML=`<div style="border:2px solid #333;border-radius:8px;padding:24px;font-size:13px;line-height:1.8"><div style="text-align:center;border-bottom:2px solid #333;padding-bottom:12px;margin-bottom:16px"><h3 style="font-size:16px">ใบสูตรผลิต (Batch Production Record)</h3><p style="color:#666">โรงพยาบาลอุตรดิตถ์ — กลุ่มงานเภสัชกรรม</p></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px"><div><strong>ชื่อตำรับ:</strong> ${f.name}</div><div><strong>ความเข้มข้น:</strong> ${f.concentration}</div><div><strong>Lot No.:</strong> ${lot}</div><div><strong>จำนวน:</strong> ${qty} ขวด</div><div><strong>วันที่ผลิต:</strong> ${fmtDate(d)}</div><div><strong>วันหมดอายุ:</strong> ${fmtDate(addDays(d,f.expiryDays))}</div></div><div style="border-top:1px solid #ccc;padding-top:12px;margin-bottom:16px"><h4 style="font-size:14px;margin-bottom:8px">ส่วนประกอบ</h4><pre style="font-family:var(--font-body);white-space:pre-wrap;background:#F9FAFB;padding:12px;border-radius:6px">${f.ingredients}</pre></div><div style="border-top:1px solid #ccc;padding-top:12px;margin-bottom:16px"><h4 style="font-size:14px;margin-bottom:8px">วิธีเตรียม</h4><pre style="font-family:var(--font-body);white-space:pre-wrap;background:#F9FAFB;padding:12px;border-radius:6px">${f.method}</pre></div><div style="border-top:2px solid #333;padding-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:20px"><div style="text-align:center"><div style="border-bottom:1px solid #999;height:50px"></div><strong>ผู้เตรียม (Prepared by)</strong><div style="color:#666;font-size:11px">วันที่: ____/____/____</div></div><div style="text-align:center"><div style="border-bottom:1px solid #999;height:50px"></div><strong>ผู้ตรวจสอบ (Checked by)</strong><div style="color:#666;font-size:11px">วันที่: ____/____/____</div></div></div></div>`;
  openM('printModal');
}

function doPrint() {
  const w=window.open('','_blank','width=600,height=800');
  w.document.write(`<html><head><title>พิมพ์</title><link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet"><style>body{font-family:'Sarabun',sans-serif;padding:20px}.label-preview{max-width:400px;margin:0 auto;border:2px solid #333;border-radius:8px;padding:16px;font-size:13px}.lh{text-align:center;border-bottom:1px solid #333;padding-bottom:8px;margin-bottom:10px}.lb{line-height:1.8}.lb .row{display:flex;justify-content:space-between}.lf{border-top:1px solid #333;margin-top:10px;padding-top:8px;font-size:11px;text-align:center;color:#666}pre{font-family:'Sarabun',sans-serif;white-space:pre-wrap}</style></head><body>${document.getElementById('printBody').innerHTML}</body></html>`);
  w.document.close();w.onload=()=>w.print();
}

// ═══ HISTORY ═══
function filterHist() {
  const s=document.getElementById('hSearch').value.toLowerCase(),rf=document.getElementById('hRoomF').value,df=document.getElementById('hFrom').value,dt=document.getElementById('hTo').value;
  let list=[...DB.preps].reverse();
  if(s)list=list.filter(p=>p.formulaName.toLowerCase().includes(s)||p.target.toLowerCase().includes(s)||p.preparedBy.toLowerCase().includes(s)||p.lotNo.toLowerCase().includes(s));
  if(rf)list=list.filter(p=>p.location===rf);
  if(df)list=list.filter(p=>p.date>=df);
  if(dt)list=list.filter(p=>p.date<=dt);
  const tb=document.getElementById('histBody');
  if(!list.length){tb.innerHTML='<tr><td colspan="9" style="text-align:center;color:var(--text-muted);padding:40px">ไม่พบรายการ</td></tr>';return}
  tb.innerHTML=list.map(p=>`<tr><td style="color:var(--text-muted);font-family:var(--font-mono);font-size:12px">${p.id}</td><td>${fmtShort(p.date)}</td><td style="font-weight:500">${p.formulaName}</td><td><span class="badge-tag ${p.mode==='patient'?'blue':'teal'}">${p.mode==='patient'?'เฉพาะราย':'Stock'}</span></td><td>${p.target}</td><td style="font-family:var(--font-mono);font-size:12px">${p.lotNo}</td><td>${p.preparedBy}</td><td><span class="badge-tag green">${p.location}</span></td><td>${curUser&&curUser.role==='admin'?`<button class="btn btn-sm btn-ghost" onclick="delPrep(${p.id})"><svg viewBox="0 0 24 24" fill="none" stroke="#DC2626" stroke-width="2" style="width:14px;height:14px"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>`:''}</td></tr>`).join('');
}

function delPrep(id){if(!confirm('ต้องการลบรายการนี้?'))return;DB.preps=DB.preps.filter(p=>p.id!==id);toast('ลบรายการสำเร็จ','success');filterHist()}

// ═══ EXPORT ═══
function exportCSV() {
  if(!DB.preps.length){toast('ไม่มีข้อมูล','error');return}
  let csv='\uFEFFID,วันที่,สูตรยา,ประเภท,ผู้ป่วย/ห้อง,Lot,จำนวน,ผู้เตรียม,สถานที่,วันหมดอายุ,หมายเหตุ\n';
  DB.preps.forEach(p=>{csv+=`${p.id},${p.date},"${p.formulaName}",${p.mode},"${p.target}",${p.lotNo},${p.qty},"${p.preparedBy}",${p.location},${p.expiryDate},"${p.note||''}"\n`});
  const b=new Blob([csv],{type:'text/csv;charset=utf-8;'}),u=URL.createObjectURL(b),a=document.createElement('a');
  a.href=u;a.download=`ED-Extemp_${today()}.csv`;a.click();URL.revokeObjectURL(u);toast('Export CSV สำเร็จ','success');
}

function exportJSON() {
  if(!DB.preps.length){toast('ไม่มีข้อมูล','error');return}
  const b=new Blob([JSON.stringify(DB.preps,null,2)],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');
  a.href=u;a.download=`ED-Extemp_${today()}.json`;a.click();URL.revokeObjectURL(u);toast('Export JSON สำเร็จ','success');
}

// ═══ FORMULA MANAGEMENT ═══
function refreshFormulas() {
  const cc={antibiotic:'blue',antifungal:'purple',steroid:'amber',lubricant:'green',other:'teal'};
  const cl={antibiotic:'Antibiotic',antifungal:'Antifungal',steroid:'Steroid',lubricant:'Lubricant',other:'Other'};
  document.getElementById('fGrid').innerHTML=DB.formulas.map(f=>`<div class="formula-card" onclick="editF(${f.id})"><h4>${f.name}</h4><div class="fdesc">${f.desc||'-'}</div><div class="fmeta"><span class="badge-tag ${cc[f.category]||'teal'}">${cl[f.category]||f.category}</span><span class="badge-tag amber">${f.concentration}</span><span class="badge-tag green">อายุ ${f.expiryDays} วัน</span>${f.price>0?`<span class="badge-tag red">${f.price} ฿</span>`:''}</div></div>`).join('');
}

function openFM(id=null) {
  editFID=id;
  if(id){const f=DB.formulas.find(x=>x.id===id);if(!f)return;document.getElementById('fmTitle').textContent='แก้ไขสูตรตำรับ';document.getElementById('fName').value=f.name;document.getElementById('fDesc').value=f.desc||'';document.getElementById('fConc').value=f.concentration||'';document.getElementById('fExp').value=f.expiryDays;document.getElementById('fIng').value=f.ingredients||'';document.getElementById('fMeth').value=f.method||'';document.getElementById('fPrice').value=f.price||0;document.getElementById('fCat').value=f.category||'other'}
  else{document.getElementById('fmTitle').textContent='เพิ่มสูตรตำรับยา';['fName','fDesc','fConc','fIng','fMeth'].forEach(i=>document.getElementById(i).value='');document.getElementById('fExp').value=7;document.getElementById('fPrice').value=0;document.getElementById('fCat').value='antibiotic'}
  openM('fmModal');
}

function editF(id){curUser&&curUser.role==='admin'?openFM(id):toast('เฉพาะ Admin ที่แก้ไขสูตรได้','info')}

function saveFormula() {
  const n=document.getElementById('fName').value.trim();if(!n){toast('กรุณากรอกชื่อสูตรตำรับ','error');return}
  const d={name:n,desc:document.getElementById('fDesc').value.trim(),concentration:document.getElementById('fConc').value.trim(),expiryDays:+document.getElementById('fExp').value||7,ingredients:document.getElementById('fIng').value.trim(),method:document.getElementById('fMeth').value.trim(),price:+document.getElementById('fPrice').value||0,category:document.getElementById('fCat').value};
  if(editFID){const f=DB.formulas.find(x=>x.id===editFID);if(f)Object.assign(f,d);toast('แก้ไขสูตรสำเร็จ','success')}
  else{d.id=DB.nFormulaId++;DB.formulas.push(d);toast('เพิ่มสูตรสำเร็จ','success')}
  closeM('fmModal');refreshFormulas();
}

// ═══ USER MANAGEMENT ═══
function refreshUsers() {
  const cols=['#2563EB','#059669','#D97706','#7C3AED','#DC2626','#0D9488'];
  document.getElementById('userBody').innerHTML=DB.users.map((u,i)=>`<tr><td><div style="display:flex;align-items:center;gap:10px"><div class="user-avatar-sm" style="background:${cols[i%6]}">${u.name.charAt(0)}</div><span style="font-weight:500">${u.name}</span></div></td><td style="font-family:var(--font-mono);font-size:13px">${u.phaId}</td><td><span class="badge-tag ${u.role==='admin'?'purple':'blue'}">${u.role==='admin'?'Admin':'User'}</span></td><td><span class="badge-tag ${u.active?'green':'red'}">${u.active?'Active':'Inactive'}</span></td><td><button class="btn btn-sm btn-ghost" onclick="toggleUser(${u.id})" title="${u.active?'ปิด':'เปิด'}ใช้งาน"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M18.36 6.64a9 9 0 1 1-12.73 0M12 2v10"/></svg></button><button class="btn btn-sm btn-ghost" onclick="delUser(${u.id})"><svg viewBox="0 0 24 24" fill="none" stroke="#DC2626" stroke-width="2" style="width:14px;height:14px"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></td></tr>`).join('');
}

function openUM(){['uName','uPhaID','uPass'].forEach(i=>document.getElementById(i).value='');document.getElementById('uRole').value='user';openM('umModal')}

function saveUser() {
  const n=document.getElementById('uName').value.trim(),p=document.getElementById('uPhaID').value.trim(),pw=document.getElementById('uPass').value,r=document.getElementById('uRole').value;
  if(!n||!p||!pw){toast('กรุณากรอกข้อมูลให้ครบ','error');return}
  if(DB.users.find(u=>u.phaId===p)){toast('รหัสนี้มีอยู่แล้ว','error');return}
  DB.users.push({id:DB.nUserId++,name:n,phaId:p,password:pw,role:r,active:true});
  closeM('umModal');refreshUsers();toast(`เพิ่ม ${n} สำเร็จ`,'success');
}

function toggleUser(id){const u=DB.users.find(x=>x.id===id);if(!u)return;if(u.id===curUser.id){toast('ไม่สามารถปิดใช้งานตนเองได้','error');return}u.active=!u.active;refreshUsers();toast(`${u.active?'เปิด':'ปิด'}ใช้งาน ${u.name}`,'success')}
function delUser(id){if(id===curUser.id){toast('ไม่สามารถลบตนเองได้','error');return}if(!confirm('ต้องการลบ?'))return;DB.users=DB.users.filter(u=>u.id!==id);refreshUsers();toast('ลบสำเร็จ','success')}

// ═══ SAMPLE DATA ═══
function addSampleData() {
  if(DB.preps.length>0)return;
  const samples=[
    {fId:1,mode:'patient',hn:'65001234',pn:'นายสมชาย รักตา',date:'2026-02-10',qty:2},
    {fId:2,mode:'patient',hn:'65005678',pn:'นางสมหญิง ดวงตา',date:'2026-02-11',qty:1},
    {fId:3,mode:'stock',room:'EYE_OPD',date:'2026-02-12',qty:3},
    {fId:1,mode:'patient',hn:'65009012',pn:'นายวิชัย สว่างตา',date:'2026-02-13',qty:2},
    {fId:4,mode:'patient',hn:'65003456',pn:'นางมาลี ใสใส',date:'2026-02-14',qty:1},
    {fId:5,mode:'patient',hn:'65007890',pn:'นายประเสริฐ ตาคม',date:'2026-02-14',qty:4},
    {fId:6,mode:'stock',room:'IPD',date:'2026-02-15',qty:2},
    {fId:2,mode:'patient',hn:'65002345',pn:'นางสาวนภา จ้องมอง',date:'2026-02-15',qty:1},
  ];
  const preparers=['ภก.สมชาย เภสัชกร','ภญ.สมหญิง ยาดี','ภก.วิชัย ตาสว่าง'];
  const locs=['OPD','PROD','OPD','IPD','OPD','PROD','IPD','OPD'];
  samples.forEach((s,i)=>{
    const f=DB.formulas.find(x=>x.id===s.fId);if(!f)return;
    DB.preps.push({id:DB.nPrepId++,formulaId:f.id,formulaName:f.name,concentration:f.concentration,mode:s.mode,
      target:s.mode==='patient'?`HN: ${s.hn} - ${s.pn}`:`Stock → ${s.room}`,
      hn:s.hn||'',patientName:s.pn||'',destRoom:s.room||'',
      lotNo:`LOT-202602-${String(i+1).padStart(3,'0')}`,date:s.date,expiryDate:addDays(s.date,f.expiryDays),
      qty:s.qty,note:'',preparedBy:preparers[i%3],location:locs[i],createdAt:new Date().toISOString()});
  });
}
</script>
</body>
</html>